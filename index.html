    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Monthly Expense Tracker</title>
        <!-- Load Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* Custom scrollbar for better visual appeal */
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: #f1f1f1; }
            ::-webkit-scrollbar-thumb { background: #c0c0c0; border-radius: 3px; }
            ::-webkit-scrollbar-thumb:hover { background: #9a9a9a; }
            
            /* Apply Inter font */
            body { font-family: 'Inter', sans-serif; background-color: #fbfbfc; }
            
            /* Style for the main container */
            .container-shadow { box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05); }

            /* Custom color classes */
            .bg-income { background-color: #d1fae5; color: #065f46; } /* Green 100/700 */
            .bg-expense { background-color: #fee2e2; color: #991b1b; } /* Red 100/700 */
            .bg-balance-pos { background-color: #10b981; color: white; } /* Emerald 500 */
            .bg-balance-neg { background-color: #f87171; color: white; } /* Red 400 */
        </style>
    </head>
    <body class="min-h-screen p-4 sm:p-8">
        
        <div id="app" class="max-w-5xl mx-auto">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Detailed Monthly Expense Tracker</h1>
            <p class="text-gray-500 mb-6">Tracking income, expenses, and net balance based on your detailed spreadsheet.</p>

            <!-- Dynamic Message/Error Box -->
            <div id="message-box" class="hidden p-3 rounded-lg text-sm mb-4" role="alert"></div>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center p-8 text-xl font-medium text-blue-500">
                Connecting to database...
            </div>

            <!-- Main Content (Hidden until loaded) -->
            <div id="main-content" class="hidden">
                
                <!-- 1. Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    
                    <!-- Total Income Card -->
                    <div class="rounded-xl p-5 bg-income container-shadow">
                        <p class="text-sm font-semibold mb-1">Total Income</p>
                        <p id="total-income" class="text-3xl font-bold">₹0.00</p>
                    </div>
                    
                    <!-- Total Expenses Card -->
                    <div class="rounded-xl p-5 bg-expense container-shadow">
                        <p class="text-sm font-semibold mb-1">Total Expenses</p>
                        <p id="total-expense" class="text-3xl font-bold">₹0.00</p>
                    </div>
                    
                    <!-- Net Balance Card -->
                    <div id="balance-card" class="rounded-xl p-5 bg-balance-pos container-shadow">
                        <p class="text-sm font-semibold mb-1 text-white">Net Balance</p>
                        <p id="net-balance" class="text-3xl font-bold text-white">₹0.00</p>
                    </div>
                </div>

                <p class="text-xs text-gray-400 mb-4">User ID: <span id="user-id">Loading...</span></p>

                <!-- 2. Transaction Form and History -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Transaction Form (lg:col-span-1) -->
                    <div class="lg:col-span-1 bg-white rounded-xl p-6 container-shadow h-fit sticky top-4">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add Transaction</h2>
                        
                        <form id="transaction-form" class="space-y-4">
                            
                            <div>
                                <label for="type" class="block text-sm font-medium text-gray-700">Type</label>
                                <select id="type" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                                    <option value="Expense">Expense</option>
                                    <option value="Income">Income</option>
                                </select>
                            </div>

                            <div>
                                <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
                                <input type="date" id="date" required value="" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>

                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                                <input type="text" id="category" required placeholder="e.g., Groceries, Salary, Rent" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                            
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description (Optional)</label>
                                <input type="text" id="description" placeholder="e.g., Starbucks coffee" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                            
                            <div>
                                <label for="amount" class="block text-sm font-medium text-gray-700">Amount (₹)</label>
                                <input type="number" id="amount" required step="0.01" min="0.01" placeholder="0.00" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                            </div>
                            
                            <button type="submit" class="w-full py-2 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                                Record Transaction
                            </button>
                        </form>
                    </div>
                    
                    <!-- Transaction History (lg:col-span-2) -->
                    <div class="lg:col-span-2 bg-white rounded-xl p-6 container-shadow">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Transaction History</h2>
                        
                        <div id="history-list" class="space-y-3">
                            <p id="empty-state" class="text-center text-gray-500 italic p-4">No transactions recorded yet.</p>
                            <!-- Transactions will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firebase Imports and Logic -->
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
            import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
            import { getFirestore, doc, addDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

            // DOM elements
            const loadingIndicator = document.getElementById('loading-indicator');
            const mainContent = document.getElementById('main-content');
            const messageBox = document.getElementById('message-box');
            const userIdDisplay = document.getElementById('user-id');
            const form = document.getElementById('transaction-form');
            const historyList = document.getElementById('history-list');
            const emptyState = document.getElementById('empty-state');
            const totalIncomeEl = document.getElementById('total-income');
            const totalExpenseEl = document.getElementById('total-expense');
            const netBalanceEl = document.getElementById('net-balance');
            const balanceCard = document.getElementById('balance-card');

            let db, auth;
            let currentUserId = null;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            /**
             * Utility function to display messages or errors.
             * @param {string} message 
             * @param {'error'|'success'|'info'} type 
             */
            function displayMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-blue-100', 'text-blue-700');
                
                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    messageBox.classList.add('bg-green-100', 'text-green-700');
                } else {
                    messageBox.classList.add('bg-blue-100', 'text-blue-700');
                }
            }

            /**
             * Initializes Firebase and authenticates the user.
             */
            async function initializeAuthAndDatabase() {
                try {
                    // IMPORTANT FIX: Robust parsing of the firebase config string
                    let firebaseConfig = {};
                    if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                        firebaseConfig = JSON.parse(__firebase_config);
                    } else {
                        throw new Error("Firebase config is missing.");
                    }

                    // Initialize services
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    setLogLevel('Debug');

                    // Authentication
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Set up the listener for auth state changes
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            userIdDisplay.textContent = currentUserId;
                            // Once authenticated, start listening to data
                            startDataListener();
                            loadingIndicator.classList.add('hidden');
                            mainContent.classList.remove('hidden');
                        } else {
                            // This should ideally not happen after initial sign-in
                            displayMessage("Authentication failed. Please try again.", 'error');
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    loadingIndicator.textContent = "Error loading application.";
                    displayMessage(`Failed to initialize application. Check console for details. Error: ${error.message}`, 'error');
                }
            }

            /**
             * Adds a new transaction to Firestore.
             * @param {Event} e 
             */
            async function handleFormSubmit(e) {
                e.preventDefault();
                if (!currentUserId) {
                    displayMessage("Authentication in progress. Please wait.", 'info');
                    return;
                }

                const type = document.getElementById('type').value;
                const dateStr = document.getElementById('date').value;
                const category = document.getElementById('category').value.trim();
                const description = document.getElementById('description').value.trim();
                const amount = parseFloat(document.getElementById('amount').value);

                if (!amount || amount <= 0 || !category) {
                    displayMessage("Please fill in a valid amount and category.", 'error');
                    return;
                }

                try {
                    // Path to store private user data
                    const collectionPath = `/artifacts/${appId}/users/${currentUserId}/transactions`;
                    
                    await addDoc(collection(db, collectionPath), {
                        type: type, // 'Income' or 'Expense'
                        date: dateStr, // Storing as YYYY-MM-DD string for simple sorting and display
                        category: category,
                        description: description,
                        amount: amount,
                        timestamp: serverTimestamp()
                    });

                    form.reset();
                    // Set default date back to today
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];

                    displayMessage(`Successfully recorded ${type}!`, 'success');

                } catch (e) {
                    console.error("Error adding document: ", e);
                    displayMessage("Failed to record transaction. Please try again.", 'error');
                }
            }

            /**
             * Starts the real-time listener for the user's transactions.
             */
            function startDataListener() {
                if (!db || !currentUserId) return;

                const collectionPath = `/artifacts/${appId}/users/${currentUserId}/transactions`;
                const q = query(collection(db, collectionPath));
                
                // Real-time listener: onSnapshot
                onSnapshot(q, (snapshot) => {
                    const transactions = [];
                    snapshot.forEach((doc) => {
                        // Extract data and include the document ID
                        transactions.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Process and render the transactions
                    updateUI(transactions);
                }, (error) => {
                    console.error("Error listening to transactions: ", error);
                    displayMessage("Failed to load history. Please check your connection.", 'error');
                });
            }

            /**
             * Deletes a transaction from Firestore.
             * @param {string} id - The Firestore document ID.
             */
            async function deleteTransaction(id) {
                if (!currentUserId) return;
                
                // NOTE: Using a custom message box is preferred over window.confirm, 
                // but for simplicity here we assume the environment handles it gracefully.
                const confirmed = window.confirm("Are you sure you want to delete this transaction?");
                if (!confirmed) return;

                try {
                    const docPath = `/artifacts/${appId}/users/${currentUserId}/transactions/${id}`;
                    await deleteDoc(doc(db, docPath));
                    displayMessage("Transaction deleted.", 'info');
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    displayMessage("Failed to delete transaction.", 'error');
                }
            }

            /**
             * Calculates totals and renders the history list.
             * @param {Array<Object>} transactions 
             */
            function updateUI(transactions) {
                let totalIncome = 0;
                let totalExpense = 0;

                // Sort transactions by date (descending)
                // Note: Sorting is done in memory to avoid potential Firestore index issues with orderBy().
                transactions.sort((a, b) => {
                    // Primary sort: Date (Newest first)
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (dateA > dateB) return -1;
                    if (dateA < dateB) return 1;
                    
                    // Secondary sort: Timestamp (to break ties on same date)
                    const timestampA = a.timestamp ? a.timestamp.toDate() : 0;
                    const timestampB = b.timestamp ? b.timestamp.toDate() : 0;
                    if (timestampA > timestampB) return -1;
                    if (timestampA < timestampB) return 1;
                    
                    return 0;
                });

                // Clear existing history
                historyList.innerHTML = '';
                
                if (transactions.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }

                // Render and calculate
                transactions.forEach(t => {
                    const amount = t.amount || 0;
                    
                    if (t.type === 'Income') {
                        totalIncome += amount;
                    } else if (t.type === 'Expense') {
                        totalExpense += amount;
                    }

                    // Create the history item element
                    const isExpense = t.type === 'Expense';
                    const colorClass = isExpense ? 'border-red-400' : 'border-green-400';
                    const sign = isExpense ? '-' : '+';
                    const signColor = isExpense ? 'text-red-600' : 'text-green-600';
                    
                    // Format date for display
                    const displayDate = t.date ? new Date(t.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Date N/A';

                    const item = document.createElement('div');
                    item.className = `flex justify-between items-center p-4 border-l-4 ${colorClass} bg-gray-50 rounded-lg transition duration-150 ease-in-out hover:bg-gray-100`;
                    item.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${t.category || 'N/A'}</p>
                            <p class="text-xs text-gray-500">${t.description || 'No description'}</p>
                            <p class="text-xs text-gray-400 mt-1">
                                ${displayDate}
                            </p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <p class="text-lg font-bold ${signColor}">
                                ${sign} ₹${amount.toFixed(2)}
                            </p>
                            <button class="delete-btn text-gray-400 hover:text-red-500 transition" data-id="${t.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    `;
                    historyList.appendChild(item);
                });

                // Update Summary
                const netBalance = totalIncome - totalExpense;
                totalIncomeEl.textContent = `₹${totalIncome.toFixed(2)}`;
                totalExpenseEl.textContent = `₹${totalExpense.toFixed(2)}`;
                netBalanceEl.textContent = `₹${netBalance.toFixed(2)}`;

                // Update Balance Card style
                balanceCard.classList.remove('bg-balance-pos', 'bg-balance-neg');
                if (netBalance >= 0) {
                    balanceCard.classList.add('bg-balance-pos');
                } else {
                    balanceCard.classList.add('bg-balance-neg');
                }

                // Attach delete listeners
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        deleteTransaction(e.currentTarget.dataset.id);
                    });
                });
            }
            
            // --- Event Listeners and Initial Setup ---
            
            // 1. Set today's date as default in the form
            document.getElementById('date').value = new Date().toISOString().split('T')[0];

            // 2. Form submission listener
            form.addEventListener('submit', handleFormSubmit);

            // 3. Start the entire application process
            initializeAuthAndDatabase();

        </script>
    </body>
    </html>
